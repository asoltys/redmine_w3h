<% css = cycle('odd','even') %>
<tr id="deliverable-<%= deliverable.id %>" class="deliverable <%= css %>">
  <td class="actions">
    <% unless deliverable.attachments.empty? %>
    <%= link_to(image_tag('pdf-icon.gif', :plugin => 'redmine_w3h'), {:controller => 'attachments', :action => 'download', :id => deliverable.attachments.last, :filename => deliverable.attachments.last.filename }) %>
    <% end %>
    <%= link_to image_tag('edit.png'), { :action => 'edit', :id => deliverable.project_id, :deliverable_id => deliverable.id }, 
      :title => l(:button_edit) %>

    <%= link_to image_tag('delete.png'), { :action => 'destroy', :id => deliverable.project_id, :deliverable_id => deliverable.id }, 
      :confirm => l(:text_are_you_sure), 
      :method => :post, 
      :title => l(:button_delete) %>
  </td>

  <%= content_tag(:td, link_to(h(deliverable), "/deliverables/edit/#{deliverable.project.id}?deliverable_id=#{deliverable.id}"), {:class => 'subject', :align => 'center'}) %>
  <%= content_tag(:td, h(deliverable.number), {:align => 'center'}) %>
  <%= content_tag(:td, number_to_currency(deliverable.forecast), {:align => 'center'}) %>
  <%= content_tag(:td, number_to_currency(deliverable.budget), {:align => 'center'}) %>
  <%= content_tag(:td, link_to(number_to_currency(deliverable.spent), "/timesheet/report?timesheet[period_type]=0&timesheet[period]=all&timesheet[deliverables][]=#{deliverable.id}"), {:align => 'center'}) %>
  <%= content_tag(:td, number_to_currency(deliverable.invoiced), {:align => 'center'}) %>
  <%= Redmine::Hook.call_hook(:plugin_budget_view_deliverable_summary_row, { :deliverable => deliverable }) %>
</tr>
<% unless @deliverable.custom_field_values.empty? %>
	<% custom_spaces_int = 4 %>
	<% custom_spaces_float = 4.0 %>
	<% row_count = 0 %>
	<% row_max = (@deliverable.custom_field_values.size / custom_spaces_float).ceil %>
	<% if (@deliverable.custom_field_values.size % custom_spaces_float) == 0 %>
		<% custom_mod = custom_spaces_int %>
	<% else %>
		<% custom_mod = (@deliverable.custom_field_values.size % custom_spaces_float) %>
	<% end %>
	
	<% while row_count < row_max do %>
		<% custom_index = row_count * custom_spaces_int %>
		<tr>
			<% if (row_max - row_count) == 1 %>
				<% head_space = 7 - custom_mod %>
				<% custom_increment = custom_mod - 1 %>
			<% else %>
				<% head_space = 3 %>
				<% custom_increment = 3 %>
			<% end %>
			<% while head_space > 0 do %>
				<%= content_tag('td', " ") %>
				<% head_space -= 1 %>
			<% end %>
			<% for custom_index in custom_index..custom_index+custom_increment do %>
				<%= content_tag(:td,number_to_currency(show_value(deliverable.custom_field_values[custom_index])), {:align => 'center'}) %>
			<% end %>
		</tr>
		<% row_count += 1 %>
	<% end %>
<% end %>